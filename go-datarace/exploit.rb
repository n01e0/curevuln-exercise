#!/usr/bin/env ruby
require 'net/http'
require 'json'
require 'concurrent'

def send_request
  url = URI('http://localhost:8019/tasks')
  data = { 'name' => 'Malicious Task' }

  begin
    http = Net::HTTP.new(url.host, url.port)
    request = Net::HTTP::Post.new(url)
    request['Content-Type'] = 'application/json'
    request.body = data.to_json

    response = http.request(request)
    JSON.parse(response.body)['id']
  rescue StandardError => e
    puts "Request failed: #{e}"
    nil
  end
end

num_requests = 100
task_ids = Concurrent::Array.new

pool = Concurrent::FixedThreadPool.new(50)

num_requests.times do
  pool.post do
    task_id = send_request
    task_ids << task_id if task_id
  end
end

pool.shutdown
pool.wait_for_termination

id_count = Hash.new(0)

task_ids.each do |task_id|
  id_count[task_id] += 1
end

duplicates = id_count.select { |_, count| count > 1 }

if duplicates.any?
  puts "Duplicate IDs detected: #{duplicates}"
else
  puts "No duplicate IDs detected"
end

