# 防御策

根本的対策としては、OSコマンドやシェル呼び出しを極力使わない実装を行う必要があります。以下、優先して採用すべき順に防御策を並べます。

* OSコマンドあるいはシェル呼び出しを使わない実装方式を選ぶ: OSコマンドあるいはシェル呼び出しを使わずに実装できる場合はそちらを採用します。たとえば前述のメール送信の例では`mb_send_mail`関数が使えます。
* シェル機能を呼び出す関数の利用を避ける: シェルを経由しない関数があればそれを使用します。（PHPには存在しません。）
* 外部から入力された文字列をコマンドラインのパラメータに渡さない: 前述のsendmailの場合であれば、コマンドラインに宛先を渡すのではなく、メールのヘッダのToフィールドに書くことで問題を回避できます。
* OSコマンドに渡すパラメータを安全な関数でエスケープする: どうしてもシェル呼び出しを行わなければならない場合は、安全な関数でシェルのメタ文字をエスケープします。PHPであれば`escapeshellarg`関数を使います。ただし、これらの関数を使っていても脆弱性が混入した例はあります。

### 保険的対策

前述した根本的対策に抜けがあった場合やミドルウェアの脆弱性があった場合、OSコマンドインジェクションの脆弱性の攻撃の被害を軽減するために、以下の対策を行います。

* パラメータの妥当性検証: アプリケーションの要件に従った入力値検証を行うことで、OSコマンドインジェクション攻撃を回避できる場合があります。
* アプリケーションの稼動するユーザ権限を最小限とする: アプリケーションを実行するユーザに対して必要最小限な権限のみを与えることで、被害を最小限にとどめられる場合があります。
* WebサーバーのOSやミドルウェアのパッチ適用: OSコマンドインジェクションで最も被害が大きくなるシナリオとして、サーバー内部からのOS脆弱性を突いた攻撃(local exploit)を受け、システムの管理者特権を奪われる場合があります。この影響を最小限とするために、脆弱性対策パッチの適用を速やかに行います。
